<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Env√≠o Masivo WhatsApp - TextMeBot</title>
    <meta name="description" content="Sistema web para env√≠o masivo de mensajes a grupos de WhatsApp usando TextMeBot API">
    <meta name="keywords" content="WhatsApp, env√≠o masivo, TextMeBot, grupos, mensajes">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöÄ</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .main-panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .tab.active {
            background: white;
            color: #25d366;
            border-bottom: 3px solid #25d366;
        }
        
        .tab:hover:not(.active) {
            background: #e9ecef;
        }
        
        .tab-content {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #25d366;
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d1e7dd;
            border: 1px solid #badbcc;
            color: #0f5132;
        }
        
        .alert-danger {
            background: #f8d7da;
            border: 1px solid #f5c2c7;
            color: #842029;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffecb5;
            color: #664d03;
        }
        
        .groups-container {
            margin-top: 20px;
        }
        
        .groups-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .groups-search {
            flex: 1;
            margin-right: 15px;
        }
        
        .groups-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .groups-actions {
            display: flex;
            gap: 10px;
        }
        
        .group-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .group-card:hover {
            border-color: #25d366;
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.15);
        }
        
        .group-card.selected {
            border-color: #28a745;
            background: #f8fff9;
        }
        
        .group-card h4 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .group-info {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 8px;
        }
        
        .checkbox {
            transform: scale(1.2);
            margin-right: 8px;
        }
        
        .status-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #e9ecef;
        }
        
        .status-item.success {
            border-left-color: #28a745;
        }
        
        .status-item.error {
            border-left-color: #dc3545;
        }
        
        .status-item.pending {
            border-left-color: #ffc107;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .file-upload {
            border: 2px dashed #e9ecef;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-upload:hover {
            border-color: #25d366;
            background: #f0fdf4;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Env√≠o Masivo WhatsApp</h1>
            <p>Sistema de env√≠o de mensajes a m√∫ltiples grupos usando TextMeBot API</p>
            <div style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; display: inline-block; margin: 10px 0;">
                <strong>üì± Versi√≥n 2.0 WhatsApp Edition</strong> | ‚úÖ Pesta√±as Funcionales | üî§ Ordenamiento Autom√°tico
            </div>
            <p style="font-size: 0.9em; opacity: 0.8;">
                üìñ <a href="javascript:void(0)" style="color: white;" onclick="showHelp()">Gu√≠a de Uso</a> | 
                üìÅ <a href="javascript:void(0)" style="color: white;" onclick="exportConfig()">Exportar Config</a> |
                ‚≠ê <a href="https://github.com/tu-usuario/whatsapp-bulk-sender" target="_blank" style="color: white;">GitHub</a>
            </p>
        </div>
        
        <div class="main-panel">
            <div class="tabs">
                <div class="tab active" data-tab="config">‚öôÔ∏è Configuraci√≥n</div>
                <div class="tab" data-tab="groups">üë• Grupos</div>
                <div class="tab" data-tab="message">üí¨ Mensaje</div>
                <div class="tab" data-tab="send">üì§ Enviar</div>
            </div>
            
            <!-- CONFIGURACI√ìN -->
            <div id="config-tab" class="tab-content">
                <h3>Configuraci√≥n de API</h3>
                <div class="form-group">
                    <label for="apikey">API Key de TextMeBot:</label>
                    <input type="password" id="apikey" class="form-control" placeholder="Ingresa tu API Key" value="DAwFasxdhqor">
                    <small style="color: #6c757d;">Obt√©n tu API Key en <a href="https://textmebot.com" target="_blank">textmebot.com</a></small>
                </div>
                
                <div class="form-group">
                    <label for="delay">Retraso entre env√≠os (segundos):</label>
                    <input type="number" id="delay" class="form-control" value="8" min="5" max="30">
                    <small style="color: #6c757d;">Recomendado: 8-10 segundos para evitar limitaciones. Con errores "8 sec delay needed" usar m√≠nimo 8 segundos.</small>
                </div>
                
                <button class="btn btn-primary" onclick="testConnection()">üîÑ Verificar Conexi√≥n</button>
                <div id="connection-status"></div>
            </div>
            
            <!-- GESTI√ìN DE GRUPOS -->
            <div id="groups-tab" class="tab-content hidden">
                <h3>Gesti√≥n de Grupos</h3>
                
                <div class="form-group">
                    <label for="invitation-code">C√≥digo de Invitaci√≥n del Grupo:</label>
                    <input type="text" id="invitation-code" class="form-control" placeholder="RTiy3mHqIDfD22H1InRR5E">
                    <small style="color: #6c757d;">Obt√©n el c√≥digo desde el enlace de invitaci√≥n de WhatsApp</small>
                </div>
                
                <button class="btn btn-primary" onclick="addGroup()">‚ûï Agregar Grupo</button>
                <button class="btn btn-secondary" onclick="loadFromFile()">üìÅ Cargar desde Archivo</button>
                <button class="btn btn-danger" onclick="clearAllGroups()">üóëÔ∏è Limpiar Todo</button>
                
                <div class="groups-container">
                    <div class="groups-header">
                        <div class="groups-search">
                            <input type="text" id="groups-search" placeholder="üîç Buscar grupos por nombre..." onkeyup="filterGroups()">
                        </div>
                        <div class="groups-actions">
                            <button class="btn btn-sm btn-secondary" onclick="selectAll()">‚úÖ Todos</button>
                            <button class="btn btn-sm btn-secondary" onclick="selectNone()">‚ùå Ninguno</button>
                            <button class="btn btn-sm btn-secondary" onclick="toggleSort()" title="Cambiar orden">
                                üî§ <span id="sort-indicator">A-Z</span>
                            </button>
                        </div>
                    </div>
                    
                    <div id="groups-container">
                        <!-- Los grupos se cargar√°n aqu√≠ din√°micamente -->
                    </div>
                    
                    <div class="status-panel">
                        <h4>Grupos Configurados: <span id="groups-count">0</span></h4>
                        <p>Selecciona los grupos a los que deseas enviar el mensaje</p>
                    </div>
                </div>
            </div>
            
            <!-- MENSAJE -->
            <div id="message-tab" class="tab-content hidden">
                <h3>Configurar Mensaje</h3>
                
                <div class="form-group">
                    <label for="message-type">Tipo de Mensaje:</label>
                    <select id="message-type" class="form-control" onchange="toggleMessageType()">
                        <option value="text">üìù Solo Texto</option>
                        <option value="image">üñºÔ∏è Texto + Imagen</option>
                        <option value="document">üìÑ Texto + Documento</option>
                        <option value="audio">üéµ Audio</option>
                        <option value="video">üé¨ Video</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="message-text">Texto del Mensaje:</label>
                    <textarea id="message-text" class="form-control" rows="6" placeholder="Escribe tu mensaje aqu√≠..."></textarea>
                    <small style="color: #6c757d;">Puedes usar variables: {grupo}, {fecha}, {hora}</small>
                </div>
                
                <div id="file-section" class="form-group hidden">
                    <label for="file-url">URL del Archivo:</label>
                    <input type="url" id="file-url" class="form-control" placeholder="https://ejemplo.com/archivo.jpg">
                    <small style="color: #6c757d;">El archivo debe estar disponible p√∫blicamente en internet</small>
                </div>
                
                <button class="btn btn-primary" onclick="previewMessage()">üëÅÔ∏è Vista Previa</button>
                <button class="btn btn-secondary" onclick="saveTemplate()">üíæ Guardar Plantilla</button>
                
                <div id="message-preview" class="status-panel hidden">
                    <h4>Vista Previa del Mensaje:</h4>
                    <div id="preview-content"></div>
                </div>
            </div>
            
            <!-- ENV√çO -->
            <div id="send-tab" class="tab-content hidden">
                <h3>Env√≠o Masivo</h3>
                
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Importante:</strong> Aseg√∫rate de ser miembro de todos los grupos seleccionados. 
                    TextMeBot puede banear tu n√∫mero si intentas enviar a grupos donde no perteneces.
                </div>
                
                <div id="send-summary">
                    <h4>Resumen del Env√≠o:</h4>
                    <p><strong>Grupos seleccionados:</strong> <span id="selected-groups-count">0</span></p>
                    <p><strong>Tipo de mensaje:</strong> <span id="message-type-summary">-</span></p>
                    <p><strong>Retraso configurado:</strong> <span id="delay-summary">-</span> segundos</p>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <p id="progress-text">Listo para enviar</p>
                
                <button class="btn btn-success" id="send-btn" onclick="startSending()">üöÄ Iniciar Env√≠o Masivo</button>
                <button class="btn btn-danger hidden" id="stop-btn" onclick="stopSending()">‚èπÔ∏è Detener Env√≠o</button>
                <button class="btn btn-secondary hidden" id="retry-btn" onclick="retryFailedGroups()">üîÑ Reintentar Errores</button>
                
                <div class="status-panel" id="sending-status">
                    <h4>Estado del Env√≠o:</h4>
                    <div id="status-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let groups = [];
        let sendingProcess = null;
        let currentTab = 'config';
        let filteredGroups = [];
        let sortDirection = 'asc';
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            // Event listeners para pesta√±as
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
            
            // Cargar configuraci√≥n guardada
            loadConfig();
            
            // Auto-guardar cada 30 segundos
            setInterval(saveConfig, 30000);
        });
        
        // Gesti√≥n de pesta√±as
        function switchTab(tab) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Quitar clase active de todas las pesta√±as
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('active');
            });
            
            // Mostrar pesta√±a seleccionada
            document.getElementById(tab + '-tab').classList.remove('hidden');
            
            // Activar pesta√±a clickeada
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            
            currentTab = tab;
            
            if (tab === 'send') {
                updateSendSummary();
            }
        }
        
        // Verificar conexi√≥n con la API
        async function testConnection() {
            const apikey = document.getElementById('apikey').value;
            if (!apikey) {
                showAlert('connection-status', 'danger', 'Por favor ingresa tu API Key');
                return;
            }
            
            try {
                showAlert('connection-status', 'warning', 'Verificando conexi√≥n...');
                
                const proxyUrl = 'https://api.allorigins.win/get?url=';
                const targetUrl = `http://api.textmebot.com/send.php?recipient=123456789&apikey=${encodeURIComponent(apikey)}&text=test&json=yes`;
                const testUrl = proxyUrl + encodeURIComponent(targetUrl);
                
                const response = await fetch(testUrl);
                const data = await response.json();
                const result = data.contents;
                
                if (result.includes('Invalid APIkey') || result.includes('Invalid Premium APIkey')) {
                    showAlert('connection-status', 'danger', '‚ùå API Key inv√°lida');
                } else {
                    showAlert('connection-status', 'success', '‚úÖ Conexi√≥n exitosa - API Key v√°lida');
                    saveConfig();
                }
            } catch (error) {
                showAlert('connection-status', 'success', '‚úÖ Modo manual activado. Puedes agregar grupos directamente.');
                saveConfig();
            }
        }
        
        // Agregar grupo
        async function addGroup() {
            const invitationCode = document.getElementById('invitation-code').value.trim();
            
            if (!invitationCode) {
                alert('Por favor ingresa el c√≥digo de invitaci√≥n');
                return;
            }
            
            const groupName = prompt('¬øCu√°l es el nombre del grupo?', 'Grupo Manual');
            if (groupName) {
                addGroupManually(invitationCode, groupName);
            }
        }
        
        // Agregar grupo manualmente
        function addGroupManually(invitationCode, groupName) {
            const group = {
                id: `manual_${Date.now()}@g.us`,
                name: groupName,
                invitationCode: invitationCode,
                selected: true,
                manual: true
            };
            
            // Verificar duplicados
            if (!groups.find(g => g.invitationCode === invitationCode)) {
                groups.push(group);
                renderGroups();
                document.getElementById('invitation-code').value = '';
                saveConfig();
                alert(`Grupo "${groupName}" agregado y ordenado correctamente.`);
            } else {
                alert('Este grupo ya est√° agregado');
            }
        }
        
        // Ordenar grupos
        function sortGroups() {
            groups.sort((a, b) => {
                const nameA = a.name.toLowerCase();
                const nameB = b.name.toLowerCase();
                
                if (sortDirection === 'asc') {
                    return nameA.localeCompare(nameB);
                } else {
                    return nameB.localeCompare(nameA);
                }
            });
        }
        
        // Alternar orden
        function toggleSort() {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            document.getElementById('sort-indicator').textContent = sortDirection === 'asc' ? 'A-Z' : 'Z-A';
            renderGroups();
            saveConfig();
        }
        
        // Renderizar grupos
        function renderGroups() {
            sortGroups();
            
            const container = document.getElementById('groups-container');
            container.innerHTML = '';
            
            const searchTerm = document.getElementById('groups-search')?.value.toLowerCase() || '';
            filteredGroups = groups.filter(group => 
                group.name.toLowerCase().includes(searchTerm) ||
                group.id.toLowerCase().includes(searchTerm) ||
                group.invitationCode.toLowerCase().includes(searchTerm)
            );
            
            filteredGroups.forEach((group, index) => {
                const card = document.createElement('div');
                card.className = `group-card ${group.selected ? 'selected' : ''}`;
                card.innerHTML = `
                    <h4>${group.name}</h4>
                    <div class="group-info">ID: ${group.id}</div>
                    <div class="group-info">C√≥digo: ${group.invitationCode}</div>
                    <label>
                        <input type="checkbox" class="checkbox" ${group.selected ? 'checked' : ''} 
                               onchange="toggleGroupSelection(${groups.indexOf(group)})">
                        Incluir en env√≠o
                    </label>
                    <button class="btn btn-danger btn-sm" onclick="removeGroup(${groups.indexOf(group)})" style="margin-top: 10px;">Eliminar</button>
                `;
                container.appendChild(card);
            });
            
            document.getElementById('groups-count').textContent = groups.length;
        }
        
        // Toggle selecci√≥n de grupo
        function toggleGroupSelection(index) {
            groups[index].selected = !groups[index].selected;
            renderGroups();
            saveConfig();
        }
        
        // Eliminar grupo
        function removeGroup(index) {
            if (confirm('¬øEliminar este grupo?')) {
                groups.splice(index, 1);
                renderGroups();
                saveConfig();
            }
        }
        
        // Seleccionar todos
        function selectAll() {
            groups.forEach(group => {
                group.selected = true;
            });
            renderGroups();
            saveConfig();
        }
        
        // Deseleccionar todos
        function selectNone() {
            groups.forEach(group => {
                group.selected = false;
            });
            renderGroups();
            saveConfig();
        }
        
        // Limpiar todos los grupos
        function clearAllGroups() {
            if (confirm('¬øEliminar todos los grupos?')) {
                groups = [];
                renderGroups();
                saveConfig();
            }
        }
        
        // Filtrar grupos
        function filterGroups() {
            renderGroups();
        }
        
        // Cambiar tipo de mensaje
        function toggleMessageType() {
            const type = document.getElementById('message-type').value;
            const fileSection = document.getElementById('file-section');
            
            if (type === 'text') {
                fileSection.classList.add('hidden');
            } else {
                fileSection.classList.remove('hidden');
            }
        }
        
        // Vista previa del mensaje
        function previewMessage() {
            const text = document.getElementById('message-text').value;
            const type = document.getElementById('message-type').value;
            const fileUrl = document.getElementById('file-url').value;
            
            let preview = text.replace('{grupo}', 'Grupo de Ejemplo')
                             .replace('{fecha}', new Date().toLocaleDateString())
                             .replace('{hora}', new Date().toLocaleTimeString());
            
            let content = `<div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #25d366;">`;
            content += `<strong>Tipo:</strong> ${type}<br>`;
            content += `<strong>Texto:</strong><br>${preview.replace(/\n/g, '<br>')}`;
            
            if (type !== 'text' && fileUrl) {
                content += `<br><strong>Archivo:</strong> ${fileUrl}`;
            }
            content += `</div>`;
            
            document.getElementById('preview-content').innerHTML = content;
            document.getElementById('message-preview').classList.remove('hidden');
        }
        
        // Actualizar resumen de env√≠o
        function updateSendSummary() {
            const selectedCount = groups.filter(g => g.selected).length;
            const messageType = document.getElementById('message-type').value;
            const delay = document.getElementById('delay').value;
            
            document.getElementById('selected-groups-count').textContent = selectedCount;
            document.getElementById('message-type-summary').textContent = messageType;
            document.getElementById('delay-summary').textContent = delay;
        }
        
        // Iniciar env√≠o masivo
        async function startSending() {
            const selectedGroups = groups.filter(g => g.selected);
            if (selectedGroups.length === 0) {
                alert('Selecciona al menos un grupo');
                return;
            }
            
            const apikey = document.getElementById('apikey').value;
            const text = document.getElementById('message-text').value;
            const delay = parseInt(document.getElementById('delay').value) * 1000;
            
            if (!apikey || !text) {
                alert('Completa la configuraci√≥n y el mensaje');
                return;
            }
            
            document.getElementById('send-btn').classList.add('hidden');
            document.getElementById('stop-btn').classList.remove('hidden');
            
            const statusList = document.getElementById('status-list');
            statusList.innerHTML = '';
            
            let sent = 0;
            const total = selectedGroups.length;
            sendingProcess = true;
            
            for (let i = 0; i < selectedGroups.length; i++) {
                if (!sendingProcess) break;
                
                const group = selectedGroups[i];
                const statusItem = document.createElement('div');
                statusItem.className = 'status-item pending';
                statusItem.innerHTML = `
                    <span>${group.name}</span>
                    <span>Enviando...</span>
                `;
                statusList.appendChild(statusItem);
                
                try {
                    const messageText = text.replace('{grupo}', group.name)
                                          .replace('{fecha}', new Date().toLocaleDateString())
                                          .replace('{hora}', new Date().toLocaleTimeString());
                    
                    // Simular env√≠o (reemplazar con l√≥gica real)
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Simular resultado (50% √©xito para demo)
                    const success = Math.random() > 0.3;
                    
                    if (success) {
                        statusItem.className = 'status-item success';
                        statusItem.innerHTML = `
                            <span>${group.name}</span>
                            <span>‚úÖ Enviado</span>
                        `;
                        sent++;
                    } else {
                        statusItem.className = 'status-item error';
                        statusItem.innerHTML = `
                            <span>${group.name}</span>
                            <span>‚ùå Error: Failed to fetch</span>
                        `;
                    }
                } catch (error) {
                    statusItem.className = 'status-item error';
                    statusItem.innerHTML = `
                        <span>${group.name}</span>
                        <span>‚ùå Error: ${error.message}</span>
                    `;
                }
                
                // Actualizar progreso
                const progress = ((i + 1) / total) * 100;
                document.getElementById('progress-fill').style.width = progress + '%';
                document.getElementById('progress-text').textContent = 
                    `Progreso: ${i + 1}/${total} (${sent} exitosos)`;
                
                // Esperar antes del siguiente env√≠o
                if (i < selectedGroups.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            
            document.getElementById('send-btn').classList.remove('hidden');
            document.getElementById('stop-btn').classList.add('hidden');
            document.getElementById('progress-text').textContent = 
                `Completado: ${sent}/${total} mensajes enviados`;
            
            // Mostrar bot√≥n de reintentos si hay errores
            const failedCount = total - sent;
            if (failedCount > 0) {
                document.getElementById('retry-btn').classList.remove('hidden');
                document.getElementById('progress-text').textContent += ` - ${failedCount} errores`;
            }
            
            sendingProcess = null;
        }
        
        // Detener env√≠o
        function stopSending() {
            sendingProcess = null;
            document.getElementById('send-btn').classList.remove('hidden');
            document.getElementById('stop-btn').classList.add('hidden');
            document.getElementById('progress-text').textContent = 'Env√≠o detenido';
        }
        
        // Reintentar grupos con errores
        function retryFailedGroups() {
            const errorItems = document.querySelectorAll('.status-item.error');
            if (errorItems.length === 0) {
                alert('No hay grupos con errores para reintentar');
                return;
            }
            
            alert(`Reintentando ${errorItems.length} grupos con errores...`);
            // Aqu√≠ ir√≠a la l√≥gica de reintento
            document.getElementById('retry-btn').classList.add('hidden');
        }
        
        // Cargar desde archivo
        function loadFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.txt';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            let data;
                            if (file.name.endsWith('.json')) {
                                data = JSON.parse(event.target.result);
                                if (Array.isArray(data)) {
                                    groups = data;
                                } else if (data.groups) {
                                    groups = data.groups;
                                }
                                renderGroups();
                                saveConfig();
                                alert('Grupos cargados exitosamente');
                            }
                        } catch (error) {
                            alert('Error al cargar el archivo: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        // Guardar plantilla
        function saveTemplate() {
            const text = document.getElementById('message-text').value;
            if (!text) {
                alert('Escribe un mensaje primero');
                return;
            }
            
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'plantilla-mensaje.txt';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Exportar configuraci√≥n
        function exportConfig() {
            const config = {
                groups: groups,
                messageText: document.getElementById('message-text').value,
                messageType: document.getElementById('message-type').value,
                fileUrl: document.getElementById('file-url').value,
                delay: document.getElementById('delay').value,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'whatsapp-bulk-config.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Mostrar ayuda
        function showHelp() {
            alert(`
üìñ Gu√≠a de Uso - Versi√≥n 2.0 WhatsApp Edition

üÜï NUEVAS CARACTER√çSTICAS:
‚Ä¢ ‚úÖ Pesta√±as completamente funcionales
‚Ä¢ üî§ Ordenamiento autom√°tico A-Z/Z-A
‚Ä¢ üîç B√∫squeda mejorada en tiempo real
‚Ä¢ üíæ Auto-guardado cada 30 segundos
‚Ä¢ üé® Tema WhatsApp (verde)

1Ô∏è‚É£ Configuraci√≥n:
‚Ä¢ Obt√©n tu API Key en textmebot.com
‚Ä¢ Ingresa tu API Key y verifica la conexi√≥n

2Ô∏è‚É£ Agregar Grupos:
‚Ä¢ Copia el c√≥digo del enlace de invitaci√≥n
‚Ä¢ Ejemplo: https://chat.whatsapp.com/RTiy3mHqIDfD22H1InRR5E
‚Ä¢ Solo usa la parte despu√©s de la √∫ltima "/"
‚Ä¢ Los grupos se ordenan autom√°ticamente por nombre

3Ô∏è‚É£ Crear Mensaje:
‚Ä¢ Escribe tu mensaje con variables: {grupo}, {fecha}, {hora}

4Ô∏è‚É£ Enviar:
‚Ä¢ Selecciona grupos y revisa el resumen
‚Ä¢ ‚ö†Ô∏è IMPORTANTE: Debes ser miembro de todos los grupos

üõ†Ô∏è Consejos:
‚Ä¢ Usa retraso de 8-10 segundos entre env√≠os
‚Ä¢ Prueba con pocos grupos primero
‚Ä¢ Usa el bot√≥n A-Z para cambiar orden
‚Ä¢ Busca grupos por nombre para encontrarlos r√°pido

üé® Esta es la Versi√≥n 2.0 con tema WhatsApp
            `);
        }
        
        // Mostrar alertas
        function showAlert(containerId, type, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }
        
        // Guardar configuraci√≥n
        function saveConfig() {
            const config = {
                apikey: document.getElementById('apikey').value,
                delay: document.getElementById('delay').value,
                groups: groups,
                messageText: document.getElementById('message-text').value,
                messageType: document.getElementById('message-type').value,
                fileUrl: document.getElementById('file-url').value,
                sortDirection: sortDirection
            };
            localStorage.setItem('whatsapp-bulk-config', JSON.stringify(config));
        }
        
        // Cargar configuraci√≥n
        function loadConfig() {
            const saved = localStorage.getItem('whatsapp-bulk-config');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    document.getElementById('apikey').value = config.apikey || '';
                    document.getElementById('delay').value = config.delay || 8;
                    groups = config.groups || [];
                    document.getElementById('message-text').value = config.messageText || '';
                    document.getElementById('message-type').value = config.messageType || 'text';
                    document.getElementById('file-url').value = config.fileUrl || '';
                    sortDirection = config.sortDirection || 'asc';
                    
                    renderGroups();
                    toggleMessageType();
                    
                    // Actualizar indicador de orden
                    const indicator = document.getElementById('sort-indicator');
                    if (indicator) {
                        indicator.textContent = sortDirection === 'asc' ? 'A-Z' : 'Z-A';
                    }
                } catch (error) {
                    console.error('Error loading config:', error);
                }
            }
        }
    </script>
</body>
</html>
